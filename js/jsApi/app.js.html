<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: app.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: app.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * ownCloud - Recover 
 * adapted from OC files_trashbin among others
 *	
 * @author Marcus Mundt &lt;marmu@mailbox.tu-berlin.de>
 * @copyright Marcus Mundt 2015
 * @license AGPL-3.0
 *
 * This code is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License, version 3,
 * as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License, version 3,
 * along with this program. If not, see &lt;http://www.gnu.org/licenses/>
 */
(function() {
    'use strict';
    /* obsolete ?
    if (!OCA.Files) {
        /**
         * Namespace for the files app
         * @namespace OCA.Files
      
        OCA.Files = {};
    }
    */
    if (!OCA.Recover) {
        /**
         * Namespace for the recover app
         * @namespace OCA.Recover
         */
        OCA.Recover = {};
    }

    /**
     * @namespace OCA.Recover.App
     * @class OCA.Recover.App
     * 
     * @classdesc init of class, fileActions and Event-Listeners 
     */
     // inherited from files
    //OCA.Recover.App = _.extend({}, OCA.Files.App, {
    // not inherited from files
    OCA.Recover.App = {
        _initialized: false,

        /**
         * Navigation control
         *
         * @member {OCA.Files.Navigation}
         */
        navigation: null,

        /**
         * File list for the "All files" section.
         *
         * @member {OCA.Files.FileList}
         */
        fileList: null,
        
        /**
        * Current data source of filelist
        * @type String
        */
        _currentSource: null,
        /**
        * Current snapshot of filelist
        * @type String
        */
        _currentSnapshot: null,
        
        /**
         * Initialize the app: sets up navgation, view and filelist
         * 
         */
        //initialize: function($el) {
        initialize: function() {
            //console.log('in init from OCA.Recover.App - will init this.fileList = new OCA.Recover.FileList');
            if (this._initialized) {
                    console.log('in init from OCA.Recover.App, initialized already true');
                    return;
            }
            this.navigation = new OCA.Recover.Navigation($('#app-navigation'));
            this.view = new OCA.Recover.View(navigation);
            this.view.renderNavigation();

            this.fileList = new OCA.Recover.FileList(
                    $('#app-content-recover'), {
                            scrollContainer: $('#app-content'),
                            fileActions: this._createFileActions()
                    }
            );
            //console.log('in init of OCA.Recover.App before manual reload');
            // hack to force loading of list -> filelist reload -> $.ajax
            this.fileList.reload();
            this._setupEvents();
            // triggers setActive, shouldn't be triggered twice!
            //this._onPopState(params);
            this._initialized = true;
        },
        /**
         * creating file actions: open for directories and recover for all items
         */
        _createFileActions: function() {
            console.log('APP createFileActions beginning');
            var fileActions = new OCA.Files.FileActions();
            //console.log('_createFileAction fileActions = ' +fileActions.actions);
            fileActions.register('dir', 'Open', OC.PERMISSION_READ, '', function (filename, context) {
                    var dir = context.fileList.getCurrentDirectory();
                    if (dir !== '/') {
                            dir = dir + '/';
                    }
                    context.fileList.changeDirectory(dir + filename);
            });

            fileActions.setDefault('dir', 'Open');
            fileActions.register('all', 'Recover', OC.PERMISSION_READ, OC.imagePath('core', 'actions/history'), function(filename, context) {
                var fileList = context.fileList;
                console.log('_createFileAction recover, filename = ' + filename);
                var dir = fileList.getCurrentDirectory();
                var tr = fileList.findFileEl(filename);
                var deleteAction = tr.children("td.date").children(".action.delete");
                deleteAction.removeClass('icon-delete').addClass('icon-loading-small');
                fileList.disableActions();
                /* not required, filename is ok
                if (fileList.getCurrentSource() !== 'octrash') {
                    filename = OCA.Recover.App.removeMtime(filename);
                    console.log('APP register recover, filename = ' + filename);
                }
                */
                // similar to filelist onClickRestoreSelected
                var params = {};
                var sources = [];
                var snapshotIds = [];
                sources.push(tr.attr("data-mime"));
                snapshotIds.push(  tr.attr("data-etag"));  
                params = {
                    files: JSON.stringify([filename]),
                    dir: dir,
                    sources: JSON.stringify(sources),
                    snapshotIds: JSON.stringify(snapshotIds)
                };
                // AJAX path for PHP!!! => now trigger route + controller
                //$.post(OC.filePath('recover', 'ajax', 'recover.php'), {    
                $.post(OC.generateUrl('/apps/recover/recover'), 
                    params,
                    _.bind(fileList._removeCallback, fileList)
                );
                console.log('RECOVER filelist RestoreSelected Sources = ' + params.sources);
                console.log('RECOVER filelist RestoreSelected Snapshots = ' + params.snapshotIds);
            }, t('recover', 'Recover'));
            return fileActions;
        },

        /**
         * Setup events based on URL changes
         */
        _setupEvents: function() {
            console.log('RECOVER app _setupEvents, onPopState only');
            OC.Util.History.addOnPopStateHandler(_.bind(this._onPopState, this));
            // detect when app changed their current directory
            // obsolete, done by files app
            //$('#app-navigation').on('itemChanged', _.bind(this._onNavigationChanged, this));
        },
        /**
         * Event handler for when the URL changed (e.g. moving back and forth in history)
         * conflicting with files onPopState!
         */
        _onPopState: function(itemId) {
            //console.log('RECOVER _onPopState anfangs itemId = ' + itemId);
            // get last active ID, the one from history will be set active in here later
            var lastId = OCA.Recover.App.navigation.getActiveLink().id;
            console.log('RECOVER app _onPopState, lastId = ' + lastId + ', current id = ' + itemId);
            if (!this.navigation.itemExists(itemId)) {
                    console.log('RECOVER app _onPopState, if item does not exist, set itemId = "recently_backed_up"');
                    // set initial view (active Link to recover)
                    itemId = 'recently_backed_up';
                    //this.navigation.loadLink(itemId);
            }
            // set active
            OCA.Recover.App.navigation.loadLink(itemId);
            // rerender content
            OCA.Recover.App.view.renderContent(itemId);
            // rerender nav, why isn't that required when clicking on nav and loading new content and nav?
            OCA.Recover.App.view.renderNavigation();
        },
        /**
         * removes the mtime which is appended by OC to every file and folder.
         * needed to get the real directory name when clicking on a folder.
         */
        removeMtime: function(name) {
           var pattern = /.d\d\d\d\d\d\d\d\d\d\d/;
           if (pattern.test(name)) {
                console.log("name in removeMtime = " + name);
                console.log('RECOVER filelist changeDir also regex found -> edit targetDir');
                // dirs start with "/" -> 1, files without -> 0
                if (name.charAt(0) === '/') {
                    name = name.substr(1, name.length - 13);
                }
                else {
                    name = name.substr(0, name.length - 13);
                }
                console.log("name in removeMtime = " + name);
                return name;
            }
            // only returning original name if pattern not found -> oc trashbin not supported anymore
            //return name;
        }
    };
})();

/** hack from files/js/app.js 
 * wait for other apps/extensions to register their event handlers and file actions
 * in the "ready" clause, also seems to be working without defer.
 */
$(document).ready(function() {
	_.defer(function() { 
            OCA.Recover.App.initialize();
	});
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OCA.Recover.App.html">App</a></li><li><a href="OCA.Recover.FileList.html">FileList</a></li><li><a href="OCA.Recover.Navigation.html">Navigation</a></li><li><a href="OCA.Recover.View.html">View</a></li></ul><h3>Namespaces</h3><ul><li><a href="OCA.Recover.html">Recover</a></li></ul><h3>Global</h3><ul><li><a href="global.html#app">app</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Tue Oct 20 2015 19:26:45 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
